
// Generated by MyGeneration Version # (1.3.0.3)

using GrowSurv.DAL;
using System;

namespace GrowSurv.BLL
{
	public class TicketMessage : _TicketMessage
	{
		public TicketMessage()
		{
		
		}

        public virtual bool getUnreadMessages(Guid UserID, int _SuppportTicketID, int IsAdmin)
        {
            string query = string.Format(@"SELECT *
                                            FROM TicketMessage TM
                                            JOIN SupportTicket ST on TM.SupportTicketID = TM.SupportTicketID
                                            WHERE TM.SupportTicketID = {0} AND
                                            ST.UserID = '{1}' AND
                                            (TM.IsDeleted = 0 OR TM.IsDeleted is null) AND
                                            (TM.IsRead = 0 OR TM.IsRead is null) AND
                                            TM.FromAdmin <> {2}", _SuppportTicketID, UserID, IsAdmin);
            return LoadFromRawSql(query);
        }

        public virtual bool getTicketMessages(int supportTicketID)
        {
            string query = string.Format(@"select TOP 50 * 
                                        from TicketMessage TM
                                        WHERE TM.SupportTicketID = {0}", supportTicketID);
            return LoadFromRawSql(query);
        }

        public virtual bool setMessagesAsRead(int supportTicketID, int IsAdmin)
        {
            string query = string.Format(@"UPDATE TicketMessage
                                            SET IsRead = 1
                                            WHERE SupportTicketID = {0}
                                            AND FromAdmin <> {1}", supportTicketID, IsAdmin);
            return LoadFromRawSql(query);
        }

        public virtual bool getLastMessageDate(int supportTicketID)
        {
            string query = string.Format(@"SELECT TOP 1 TM.MessageDate AS LastMessageDate
                                            FROM TicketMessage TM
                                            WHERE TM.SupportTicketID = {0}
                                            ORDER BY TM.MessageDate DESC", supportTicketID);
            return LoadFromRawSql(query);
        }
    }
}
